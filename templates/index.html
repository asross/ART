<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Perihelion</title>
        <link rel="stylesheet" href="/static/style.css">
    </head>
    <body>
      <div id="container">
        <div id="image"></div>
        <div id="chat">
          <div id="messages">
            <p><span>&hellip;</span></p>
          </div>

          <form id="message-form">
            <input type="submit" hidden />
            <input type="text" id="message-input"/>
          </form>
        </div>
      </div>
    </body>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script>
        $(document).ready(async () => {
          const $form = $("#message-form");
          const $input = $("#message-input");
          const $messages = $("#messages");
          const q = new URLSearchParams(location.search);
          let threadId = q.get('thread');
          let messages = [];

          if (!threadId) {
            const threadResp = await fetch('/threads', { method: 'POST' });
            threadId = await threadResp.text();
            q.set('thread', threadId);
            history.replaceState({}, '', `${location.pathname}?${q}`);
          }
          
          const getMessages = async () => {
            const msgResp = await fetch(`/messages/${threadId}`);
            messages = await msgResp.json();
            messages.push('Hello passenger, welcome to the Perihelion.');
            messages.reverse();
            const elems = messages.map(msg => `<p><span>${msg || '&hellip;'}</span></p>`);
            $messages.html(elems.join(""));
            $messages[0].scrollTop = $messages[0].scrollHeight;
          };

          const numMessages = () => messages.filter(msg => msg && msg.length > 0).length;

          const awaitNewMessages = async (expectedNumMessages) => {
            await getMessages();
            while (numMessages() < expectedNumMessages) {
              await new Promise(r => setTimeout(r, 1000));
              await getMessages();
            }
          }

          awaitNewMessages();

          $form.submit(async (event) => {
            event.preventDefault();
            const message = $input.val();
            if (message.length) {
              $input.val(''); 
              $input.prop('disabled', true);
              const expectedNumMessages = messages.length + 2;
              await fetch(`/messages/${threadId}`, {
                method: 'POST',
                body: JSON.stringify({ message }),
                headers: { 'Content-Type': 'application/json' }
              });
              await awaitNewMessages(expectedNumMessages);
              $input.prop('disabled', false);
            }
          });
        });
    </script>
</html>
